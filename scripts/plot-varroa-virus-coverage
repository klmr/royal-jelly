#!/usr/bin/env/Rscript

sys = modules::import('klmr/sys')

sys$run({
    args = list(
        plus = 'data/coverage/short/MJ3-13-19_S6_merged_001.bw',
        minus = 'data/coverage/short/MJ3-13-19_S5_merged_001-minus.bw',
        annotation = '../shared/annotation/Apis_mellifera.GCA_000002195.1-viruses/Apis_mellifera.GCA_000002195.1.32-viruses.gtf'
    )
    rtl = modules::import_package('rtracklayer')
    gr = modules::import_package('GenomicRanges')

    modules::import_package('dplyr', attach = TRUE)

    annotation = rtl$import(args$annotation)

    varroa_seqname = gr$seqnames(annotation) %>%
        `[`(grep('Varroa', gr$mcols(annotation)$gene_name)) %>%
        as.character() %>%
        head(1)

    varroa_annotation = annotation[gr$seqnames(annotation) == varroa_seqname][1]

    varroa_coverage = function (coverage) {
        result = coverage[gr$seqnames(coverage) == varroa_seqname]
        GenomeInfoDb::seqlevels(result) = varroa_seqname
        result
    }

    coverage_plus = varroa_coverage(rtl$import(args$plus))
    coverage_minus = varroa_coverage(rtl$import(args$minus))

    tile_range = function (range, tiles)
        seq(range[1], range[2], length.out = tiles + 1)

    nice_ceiling = function (n, accuracy)
        ceiling(n / accuracy) * accuracy

    modules::import('coverage_plot', attach = TRUE)
    modules::import('klmr/ggplots', attach = TRUE)
    theme_set(theme_publication())

    max_coverage = max(coverage_plus$score)

    ggcoverage(coverage_plus) +
        geom_area() +
        scale_x_genomic(multiplier = 1e3) +
        scale_y_continuous(labels = scales::comma, breaks = c(0, max_coverage)) +
        theme(axis.ticks.x = element_line())
})

# vim: ft=r
